<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dipin's Dreamy Garden</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Plus+Jakarta+Sans:wght@300;600&display=swap');
        
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #0a0510; color: white; font-family: 'Plus Jakarta Sans', sans-serif; }
        #three-container { position: fixed; inset: 0; display: none; z-index: 10; background: radial-gradient(circle at center, #2d1b4e 0%, #000 100%); }
        
        .fade-in { animation: fadeIn 1.5s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #start-screen, #reveal-screen { 
            position: fixed; inset: 0; z-index: 1000; 
            background: radial-gradient(circle at bottom, #4c1d95 0%, #0a0510 100%);
            display: flex; flex-direction: column; items: center; justify-content: center; 
        }
        .cursive { font-family: 'Dancing Script', cursive; }
        
        #hud { 
            position: fixed; top: 40px; width: 100%; text-align: center; z-index: 500; 
            opacity: 0; pointer-events: none; transition: all 0.8s ease; 
        }
        .bar-bg { 
            width: 300px; height: 10px; background: rgba(255,255,255,0.1); 
            border-radius: 20px; margin: 15px auto; overflow: hidden;
            backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2);
        }
        #bar-fill { 
            width: 0%; height: 100%; background: linear-gradient(90deg, #f43f5e, #fb7185); 
            box-shadow: 0 0 20px #f43f5e; transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }

        #basket { 
            position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); 
            font-size: 5rem; z-index: 100; pointer-events: none; opacity: 0; 
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.5));
            transition: opacity 0.5s;
        }

        .final-card {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            background: rgba(15, 7, 32, 0.6); backdrop-filter: blur(25px);
            padding: 4rem; border-radius: 3rem; border: 1px solid rgba(251, 191, 36, 0.3);
            text-align: center; opacity: 0; transition: all 3s ease-out; z-index: 2000; pointer-events: none;
            box-shadow: 0 0 120px rgba(244, 63, 94, 0.2);
        }
        .final-card.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }

        .user-pic { 
            width: 180px; height: 180px; object-fit: cover; border-radius: 50%; 
            border: 4px solid #fbbf24; margin: 0 auto 2rem; 
            box-shadow: 0 0 40px rgba(251, 191, 36, 0.4); 
        }

        #game-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 50; }

        .score-pop { animation: pop 0.3s ease; }
        @keyframes pop { 50% { transform: scale(1.2); color: #fb7185; } }
        
        .shake { animation: shake 0.4s linear; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
    </style>
</head>
<body>

    <audio id="gameSfx" loop preload="auto">
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
    </audio>
    <audio id="winSong" loop preload="auto">
        <source src="song.mp3" type="audio/mpeg">
    </audio>
    <audio id="yay" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3" type="audio/mpeg">
    </audio>
    <audio id="neh" preload="auto">
        <source src="https://gfxsounds.com/wp-content/uploads/2023/03/Beep-error.mp3" type="audio/mpeg">
    </audio>

    <div id="start-screen">
        <h1 class="cursive text-8xl text-rose-200 mb-8 drop-shadow-lg text-center">Dipin's Garden</h1>
        <p class="text-rose-300 mb-10 tracking-widest uppercase text-sm">A Little Surprise For You</p>
        <button onclick="begin()" class="cursive text-3xl text-white bg-gradient-to-r from-rose-600 to-rose-400 px-12 py-4 rounded-full hover:scale-110 hover:shadow-[0_0_30px_#e11d48] transition-all duration-300">Enter Garden</button>
    </div>

    <div id="reveal-screen" style="display:none;">
        <h2 class="cursive text-6xl text-white mb-10 text-center px-4">You've caught my heart.</h2>
        <button onclick="bloom()" class="cursive text-5xl text-white bg-gradient-to-r from-amber-600 to-yellow-500 px-16 py-6 rounded-full animate-bounce shadow-2xl">Reveal The Garden</button>
    </div>

    <div id="hud">
        <div class="text-rose-100 text-5xl cursive mb-2" id="score-wrapper"><span id="score">0</span> / 20</div>
        <div class="bar-bg"><div id="bar-fill"></div></div>
        <p class="text-rose-300 text-xs uppercase tracking-[0.3em]">Collect Roses to Bloom</p>
    </div>

    <div id="basket">ðŸ§º</div>
    <canvas id="game-canvas"></canvas>
    <div id="three-container"></div>

    <div id="final-card" class="final-card">
        <img src="rose.JPG" class="user-pic" alt="Budi">
        <h1 class="cursive text-7xl text-rose-100 mb-6">Happy Rose Day, Budi</h1>
        <div class="w-24 h-1 bg-rose-500 mx-auto mb-6 rounded-full"></div>
        <p class="text-rose-100 text-2xl italic max-w-lg mx-auto leading-relaxed">
            "Real ma rose dina napayani mailey yo sundar bagaicha banako xu, happy rose day sanu!"
        </p>
    </div>

    <script>
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const basket = document.getElementById('basket');
        const fill = document.getElementById('bar-fill');
        const scoreWrap = document.getElementById('score-wrapper');
        const gameSfx = document.getElementById('gameSfx');
        const winSong = document.getElementById('winSong');
        
        let audioContext;
        let width, height, score = 0, active = false, items = [], mouseX = 0, mouseY = 0;

        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        // Initialize Audio Context on first click
        async function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }
        }

        async function begin() {
            await initAudio(); // Essential for Chrome
            document.getElementById('start-screen').style.display = 'none';
            
            // Start game music
            gameSfx.play().catch(e => console.log("Audio play blocked:", e));
            
            document.getElementById('hud').style.opacity = '1';
            basket.style.opacity = '1';
            active = true;
            loop();
        }

        class Drop {
            constructor() {
                this.x = Math.random() * width; 
                this.y = -60; 
                this.speed = Math.random() * 2 + 4;
                this.rotation = Math.random() * Math.PI * 2;
                this.rotSpeed = (Math.random() - 0.5) * 0.1;
                const r = Math.random(); 
                this.emoji = r > 0.45 ? 'ðŸŒ¹' : 'ðŸ¤';
                this.type = r > 0.45 ? 'good' : 'bad';
            }
            update() {
                this.y += this.speed;
                this.rotation += this.rotSpeed;
                this.x += Math.sin(this.y / 50) * 1.5;

                let bx = basket.offsetLeft;
                if (this.y > height - 140 && this.y < height - 60 && this.x > bx - 70 && this.x < bx + 70) {
                    if (this.type === 'good') { 
                        score++; 
                        const sfx = document.getElementById('yay');
                        sfx.currentTime = 0;
                        sfx.play().catch(()=>{});
                        scoreWrap.classList.remove('score-pop');
                        void scoreWrap.offsetWidth;
                        scoreWrap.classList.add('score-pop');
                    }
                    else { 
                        score = Math.max(0, score - 1); 
                        const sfx = document.getElementById('neh');
                        sfx.currentTime = 0;
                        sfx.play().catch(()=>{});
                        document.body.classList.add('shake');
                        setTimeout(() => document.body.classList.remove('shake'), 400);
                    }
                    document.getElementById('score').innerText = score;
                    fill.style.width = (score / 20 * 100) + '%';
                    if (score >= 20) finish(); return false;
                }
                return this.y < height + 60;
            }
            draw() { 
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                ctx.font = '50px serif'; 
                ctx.shadowBlur = 15;
                ctx.shadowColor = this.type === 'good' ? '#f43f5e' : '#fff';
                ctx.fillText(this.emoji, -25, 25);
                ctx.restore();
            }
        }

        function finish() { 
            active = false; 
            gameSfx.pause(); 
            document.getElementById('hud').style.opacity = '0'; 
            basket.style.opacity = '0'; 
            setTimeout(() => { document.getElementById('reveal-screen').style.display = 'flex'; }, 800); 
        }

        let scene, camera, renderer, roseGroups = [], butterflies = [], stars;

        function initThree() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x0a0510, 0.04);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('three-container').appendChild(renderer.domElement);

            const moonGeo = new THREE.SphereGeometry(4, 32, 32);
            const moonMat = new THREE.MeshBasicMaterial({ color: 0xffffee });
            const moon = new THREE.Mesh(moonGeo, moonMat);
            moon.position.set(12, 18, -45);
            scene.add(moon);

            const starGeo = new THREE.BufferGeometry();
            const starPoints = [];
            for(let i=0; i<1200; i++) starPoints.push((Math.random()-0.5)*150, (Math.random()-0.5)*150, (Math.random()-0.5)*150);
            starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPoints, 3));
            stars = new THREE.Points(starGeo, new THREE.PointsMaterial({color: 0xffffff, size: 0.08, transparent: true, opacity: 0.8}));
            scene.add(stars);

            const roseCanvas = document.createElement('canvas'); roseCanvas.width = 128; roseCanvas.height = 128;
            const rCtx = roseCanvas.getContext('2d'); rCtx.font = '100px serif'; rCtx.fillText('ðŸŒ¹', 10, 100);
            const roseTex = new THREE.CanvasTexture(roseCanvas);

            for(let i=0; i<180; i++) {
                const group = new THREE.Group();
                const stemH = Math.random() * 5 + 4;
                const stem = new THREE.Mesh(new THREE.CylinderGeometry(0.02, 0.05, stemH), new THREE.MeshPhongMaterial({color: 0x0f2d0f}));
                stem.position.y = stemH/2;
                group.add(stem);

                const head = new THREE.Sprite(new THREE.SpriteMaterial({map: roseTex, transparent: true}));
                head.position.y = stemH + 0.4;
                head.scale.set(1.8, 1.8, 1);
                group.add(head);

                group.position.set((Math.random()-0.5)*80, -stemH - 8, (Math.random()-0.5)*60 - 15);
                scene.add(group);
                roseGroups.push({obj: group, targetY: -3, delay: i * 15, phase: Math.random() * 10});
            }

            for(let i=0; i<20; i++) {
                const b = new THREE.Mesh(new THREE.PlaneGeometry(0.5, 0.4), new THREE.MeshBasicMaterial({color: 0xffdd44, side: THREE.DoubleSide, transparent: true, opacity: 0.9}));
                b.position.set((Math.random()-0.5)*40, Math.random()*15, (Math.random()-0.5)*40);
                scene.add(b);
                butterflies.push({obj: b, phase: Math.random()*10, speed: 0.02 + Math.random()*0.02});
            }

            scene.add(new THREE.AmbientLight(0x442266));
            const pLight = new THREE.PointLight(0xff4488, 3, 60); pLight.position.set(0, 10, 0); scene.add(pLight);
            camera.position.set(0, 5, 25);
        }

        async function bloom() {
            await initAudio();
            winSong.currentTime = 0;
            winSong.play().catch(e => console.log("Final song blocked:", e));

            document.getElementById('reveal-screen').style.display = 'none';
            document.getElementById('three-container').style.display = 'block';
            initThree();
            animateThree();
            setTimeout(() => { document.getElementById('final-card').classList.add('show'); }, 6000);
        }

        function animateThree() {
            requestAnimationFrame(animateThree);
            const targetX = (mouseX / window.innerWidth - 0.5) * 12;
            const targetY = (mouseY / window.innerHeight - 0.5) * -4 + 5;
            camera.position.x += (targetX - camera.position.x) * 0.03;
            camera.position.y += (targetY - camera.position.y) * 0.03;
            camera.lookAt(0, 6, -10);

            roseGroups.forEach((r) => {
                if (r.obj.position.y < r.targetY) r.obj.position.y += 0.08;
                r.obj.rotation.z = Math.sin(Date.now() * 0.0008 + r.phase) * 0.1;
                r.obj.rotation.x = Math.cos(Date.now() * 0.0005 + r.phase) * 0.05;
            });

            butterflies.forEach(b => {
                b.phase += b.speed;
                b.obj.position.y += Math.sin(b.phase) * 0.04;
                b.obj.position.x += Math.cos(b.phase) * 0.03;
                b.obj.rotation.y = Math.sin(b.phase * 8) * 1.2;
            });

            stars.rotation.y += 0.0003;
            renderer.render(scene, camera);
        }

        function loop() {
            ctx.clearRect(0, 0, width, height);
            if (active) {
                if (Math.random() < 0.06) items.push(new Drop());
                items = items.filter(it => { it.draw(); return it.update(); });
                requestAnimationFrame(loop);
            }
        }

        window.addEventListener('mousemove', (e) => {
            mouseX = e.clientX; mouseY = e.clientY;
            if (active) {
                const targetX = e.clientX;
                const currentX = parseFloat(basket.style.left) || width/2;
                basket.style.left = targetX + 'px';
                basket.style.transform = `translateX(-50%) rotate(${(targetX - currentX) * 0.5}deg)`;
            }
        });
    </script>
</body>
</html>